# erp-code - 优化建议

> **最后更新**: 2025-12-01

## 代码组织

### 按业务模块分类

```
src/flows/
├── 客户管理/
│   ├── 创建客户.js
│   ├── 更新客户.js
│   └── 删除客户.js
├── 订单管理/
└── 项目管理/
```

---

## 性能优化

### 1. 缓存流程代码

```typescript
// 内存缓存
const cacheMap = new Map();

async getFlowCode(key: string) {
  if (cacheMap.has(key)) {
    return cacheMap.get(key);
  }
  
  const flow = await this.findByKey(key);
  cacheMap.set(key, flow);
  
  return flow;
}
```

### 2. 限制代码大小

- 单个流程文件 < 200 行
- 复杂逻辑拆分成多个流程

---

## 安全性

### 1. 输入验证

```javascript
// ✅ 验证参数
const { name, phone } = params;
if (!name || name.length > 100) {
  throw new Error('名称无效');
}
```

### 2. 权限控制

```javascript
// 检查用户权限
if (!user.hasPermission('customer:create')) {
  throw new Error('无权限');
}
```

---

## 并发控制

### updateTime  机制

- 保存前对比 updateTime  
- 不一致则拒绝，提示冲突
- 用户手动解决冲突后重试

---

## 最佳实践

1. **函数化**: 将重复逻辑抽取为函数
2. **异步处理**: 使用 async/await
3. **错误处理**: try-catch 捕获异常
4. **日志记录**: 关键操作记录日志
