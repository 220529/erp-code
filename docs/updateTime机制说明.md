# @updateTime 机制说明

## 📖 概述

`@updateTime` 是一个**乐观锁机制**，用于防止多人协作时的代码覆盖冲突。

## 🎯 核心作用

### 1. **乐观锁（并发控制）**
当多个开发者同时编辑同一个流程时，防止相互覆盖：

```
场景：
1. 开发者 A 从数据库拉取代码，updateTime = 09:00:00
2. 开发者 B 也拉取代码，updateTime = 09:00:00
3. 开发者 B 修改并保存，数据库 updateTime 更新为 09:10:00
4. 开发者 A 也修改并保存
   ❌ 此时检测到冲突：文件时间 09:00:00 ≠ 数据库时间 09:10:00
   🚫 拒绝保存，提示开发者 A 刷新代码后再编辑
```

### 2. **缓存管理**
在 `erp-core` 的 `CodeExecutorService` 中：
- 使用 `updateTime` 判断缓存是否过期
- 如果数据库中的代码更新了，自动清除缓存并重新加载

### 3. **版本追踪**
- 每次成功保存后，自动更新 `@updateTime` 为当前服务器时间
- 可以通过时间戳追踪代码的修改历史

## 🔧 工作流程

### 创建新流程
```javascript
/**
 * @flowKey customer/create
 * @flowName 创建客户
 * @description 创建客户流程
 * @updateTime 2025-10-30 10:00:00  ← 首次创建时填写当前时间
 */
```

**结果**：
- 代码保存到数据库
- 数据库记录 `updatedAt = 2025-10-30 10:00:00`

### 更新现有流程
```javascript
/**
 * @updateTime 2025-10-30 10:00:00  ← 文件中的时间
 */
```

**上传时**：
1. 提取文件中的 `@updateTime = 10:00:00`
2. 查询数据库中的 `updatedAt = 10:00:00`
3. **对比时间**：
   - ✅ **相同** → 允许保存，更新数据库时间为 `10:15:00`
   - ❌ **不同** → 拒绝保存，提示冲突

**成功后**：
- 自动更新文件中的 `@updateTime = 10:15:00`
- 数据库 `updatedAt = 10:15:00`

## 📝 使用示例

### 1. 新建流程
```javascript
/**
 * @flowKey order/create
 * @flowName 创建订单
 * @description 订单创建流程
 * @updateTime 2025-10-30 15:00:00  ← 填写当前时间
 */

const { repositories, params } = context;
// ... 业务代码 ...
```

**保存后**：`@updateTime` 会自动更新为服务器时间

### 2. 编辑流程
修改代码 → 按 `Ctrl+S` 保存

**自动处理**：
- ✅ 时间匹配 → 保存成功，`@updateTime` 自动更新
- ❌ 时间冲突 → 保存失败，显示：
  ```
  ⚠️  更新冲突！代码已被他人修改
  文件时间: 2025-10-30 10:00:00
  数据库时间: 2025-10-30 10:30:00
  
  💡 请修改文件中的 @updateTime 为: 2025-10-30 10:30:00
  ```

### 3. 解决冲突
**方法一**：手动更新时间
```javascript
/**
 * @updateTime 2025-10-30 10:30:00  ← 改为数据库中的时间
 */
```

**方法二**：重新从数据库拉取最新代码
- 合并你的修改
- 再次保存

## ⚙️ 技术实现

### 文件格式
```javascript
/**
 * @updateTime YYYY-MM-DD HH:mm:ss
 */
```

### 正则提取
```javascript
const updateTimeMatch = codeContent.match(/@updateTime\s+(.+)/);
const updateTime = updateTimeMatch ? updateTimeMatch[1].trim() : null;
```

### 自动更新
```javascript
const updateTimeRegex = /(@updateTime\s+)\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}/;
const updatedContent = originalContent.replace(
  updateTimeRegex, 
  `$1${newUpdateTime}`
);
fs.writeFileSync(filePath, updatedContent, 'utf-8');
```

### 冲突检测
```typescript
if (updateTime !== dbUpdateTime) {
  return {
    success: false,
    action: 'conflict',
    message: '更新时间不一致，代码可能已被他人修改...',
  };
}
```

## 🎨 输出示例

### 成功保存
```
╔══════════════════════════════════════════════════════════╗
║                    ✅ 上传成功！                          ║
╚══════════════════════════════════════════════════════════╝
  📁 文件: 创建客户
  🔑 流程码: customer/create
  📂 分类: 客户管理
  🗄️  数据库: erp_core
  ⏰ 原时间: 2025-10-30 10:00:00
  🆕 新时间: 2025-10-30 10:15:23
  🔄 更新 | 10:15:23
────────────────────────────────────────────────────────────
  ✏️  已更新文件时间戳: 2025-10-30 10:15:23
```

### 冲突失败
```
╔══════════════════════════════════════════════════════════╗
║                    ❌ 上传失败！                          ║
╚══════════════════════════════════════════════════════════╝
  ⚠️  错误: ⚠️  更新冲突！代码已被他人修改
文件时间: 2025-10-30 10:00:00
数据库时间: 2025-10-30 10:30:00

💡 请修改文件中的 @updateTime 为: 2025-10-30 10:30:00
  🕐 时间: 10:35:42
────────────────────────────────────────────────────────────
```

## 💡 最佳实践

1. **首次创建**：填写当前时间
2. **编辑前**：确保从数据库拉取最新代码
3. **保存后**：检查 `@updateTime` 是否自动更新
4. **冲突时**：
   - 保存当前修改
   - 拉取最新代码
   - 合并修改
   - 重新保存

## 🔒 原理说明

这是一种**乐观锁**实现：
- 不像**悲观锁**（数据库行锁）那样在读取时就加锁
- 而是在**更新时检查版本**，如果版本不匹配则拒绝更新
- 优点：性能高，适合读多写少的场景
- 缺点：可能需要重试，但对于代码编辑场景完全够用

## 📚 参考

- 原项目实现：`t1-code/src/codeFlow/低代码相关/快速保存代码流程等.js`
- erp-core 实现：`src/modules/code/code-executor.service.ts`
- 上传脚本：`scripts/upload-with-notify.js`

