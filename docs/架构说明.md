# erp-code - 架构说明

> **最后更新**: 2025-12-01

## 设计理念

动态业务代码仓库 - 业务逻辑热更新，无需重启服务

## 核心机制

### 代码存储

```
src/flows/
├── 客户管理/
│   ├── 创建客户.js
│   └── 更新客户.js
└── 订单管理/
    └── 创建订单.js
```

### 代码格式

```javascript
/**
 * @flowKey customer/create
 * @flowName 创建客户
 * @updateTime 2025-12-01 10:00:00
 */

const { repositories, params, user } = context;
const { customerRepository } = repositories;

// 业务逻辑
const customer = await customerRepository.save({
  name: params.name,
  phone: params.phone,
  createdBy: user.id,
});

return { success: true, data: customer };
```

### 执行流程

```
1. erp-core 接收请求 /api/run-flow?key=customer/create
2. BusinessFlowService 查询数据库获取代码
3. 注入 context (repositories, params, user)
4. new Function动态执行
5. 返回结果
```

## 乐观锁机制

| 场景 | 动作 | 结果 |
|------|------|------|
| **创建时** | 记录 updateTime | 写入数据库 |
| **修改时** | 对比 updateTime | 一致则更新，否则拒绝 |
| **冲突时** | 提示用户 | 手动解决冲突 |

## 开发工作流

```bash
# 1. 编辑流程文件
vim src/flows/客户管理/创建客户.js

# 2. 保存 (Ctrl+S)
# Run On Save 自动上传

# 3. 验证
# 调用 API 测试
```

## 可用 Repositories

- userRepository
- customerRepository  
- orderRepository
- projectRepository
- materialRepository
- paymentRepository
- dictRepository

## 相关文档

- [updateTime机制](./updateTime机制说明.md)
- [优化建议](./优化建议.md)
